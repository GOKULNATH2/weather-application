!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("leaflet"),require("leaflet-control-geocoder")):"function"==typeof define&&define.amd?define("map-library",["exports","@angular/core","leaflet","leaflet-control-geocoder"],t):t((e=e||self)["map-library"]={},e.ng.core,e.leaflet)}(this,(function(e,t,n){"use strict";var i,a=function(){function e(){}return e.ɵfac=function(t){return new(t||e)},e.ɵprov=t.ɵɵdefineInjectable({token:e,factory:e.ɵfac,providedIn:"root"}),e}();(i=e.CONST||(e.CONST={}))[i.ZOOM_MAX=18]="ZOOM_MAX",i[i.ZOOM_MIN=2]="ZOOM_MIN",i[i.LAT_MAX=85]="LAT_MAX";var o=function(){function i(e){this.elem=e,this.mapLat=45,this.mapLng=5,this.mapZoom=5,this.onchange=new t.EventEmitter,this.onselect=new t.EventEmitter,this.searchInputFocused=!1,this.moveMode=!0,this.handleIcon="move",this.handleMenuIcon="zoom",this.displayMenu="",this.choiseMenu=1,this.navigate=!1,this.navigateId=0,this.mapMarkers=[]}return i.prototype.ngAfterViewInit=function(){var e=this;this.initMap(),this.initInput(),this.setMoveShift(),this.setSearch(this.search),this.setMarker(this.marker),setTimeout((function(){e.sendModifications("")}),2e3)},i.prototype.initMap=function(){this.map=n.map("map",{attributionControl:!1,zoomControl:!1,center:[this.mapLat,this.mapLng],zoom:this.mapZoom}),n.tileLayer("https://{s}.tile.osm.org/{z}/{x}/{y}.png").addTo(this.map),this.map.keyboard.disable(),this.geocoder=n.Control.geocoder({position:"topleft",collapsed:!1,placeholder:"Recherche...",defaultMarkGeocode:!0}).addTo(this.map)},i.prototype.setSearch=function(e){var t=this;this.search&&(this.geocoder.setQuery(e)._geocode(),setTimeout((function(){t.geocoder._results&&t.geocoder._results.length&&(t.geocoder._geocodeResultSelected(t.geocoder._results[0]),t.geocoder._clearResults())}),2e3))},i.prototype.setMarker=function(e){var t=this;this.cleanMarkers();var i=0;e.forEach((function(e){"lat"in e&&"lng"in e&&(e.id=i,!e.text&&e.img?t.mapMarkers[i]=t.generateImageMarker(e):e.text?t.mapMarkers[i]=t.generateIconMarker(e):t.mapMarkers[i]=n.marker([e.lat,e.lng]),t.mapMarkers[i].addTo(t.map),t.navigate&&t.mapLat==e.lat&&t.mapLng==e.lng&&(t.navigateId=i,t.elem.nativeElement.querySelector("#marker_"+t.navigateId).style.background="orange"),i++)}))},i.prototype.cleanMarkers=function(){for(var e=0;e<this.mapMarkers.length;e++)this.map.removeLayer(this.mapMarkers[e])},i.prototype.generateIconMarker=function(e){var t='\n      <div class="marker" id="marker_'+e.id+'">\n        <div>'+e.text+"</div>\n        "+(e.content?"<span>"+e.content+"</span>":"")+(e.img?'<img src="'+e.img+'"/>':"")+"\n      </div>";return new n.Marker([e.lat,e.lng],{icon:new n.DivIcon({className:"",iconSize:[100,70],iconAnchor:[60,e.img?40:10],html:t})})},i.prototype.generateImageMarker=function(e){var t='<img id="marker_'+e.id+'" style="width:80px;" src="'+e.img+'"/>';return new n.Marker([e.lat,e.lng],{icon:new n.DivIcon({className:"",iconSize:[80,70],iconAnchor:[45,e.img?40:10],html:t})})},i.prototype.ngOnChanges=function(e){if(this.map)switch(Object.keys(e)[0]){case"mapZoom":case"mapLat":case"mapLng":this.map.setView([this.mapLat,this.mapLng],this.mapZoom),this.setMoveShift();break;case"marker":this.setMarker(this.marker);break;case"search":this.setSearch(this.search)}},i.prototype.keyEvent=function(e){this.focused&&(""!=this.displayMenu?this.handlingMenu(e.key):this.navigate?this.handlingNavigation(e.key):(this.handlingMap(e.key),this.sendModifications(e.key)))},i.prototype.handlingNavigation=function(e){switch(e){case"ArrowUp":this.navigateMarker(1,0);break;case"ArrowDown":this.navigateMarker(-1,0);break;case"ArrowRight":this.navigateMarker(0,1);break;case"ArrowLeft":this.navigateMarker(0,-1);break;case"Enter":this.marker[this.navigateId]&&this.sendSelectEvent(this.marker[this.navigateId]);break;case"Escape":this.openMenu()}},i.prototype.handlingMenu=function(e){switch(e){case"ArrowRight":this.choiseMenu++,this.choiseMenu>4&&(this.choiseMenu=0);break;case"ArrowLeft":this.choiseMenu--,this.choiseMenu<0&&(this.choiseMenu=4);break;case"Enter":this.navigate=!1,0==this.choiseMenu?this.setFocus():this.setFocusOut(),1==this.choiseMenu?(this.handleIcon="move",this.moveMode=!0):2==this.choiseMenu?(this.handleIcon="zoom",this.moveMode=!1):3==this.choiseMenu?this.setNavigationMode():4==this.choiseMenu&&alert("exit"),this.closeMenu();break;case"Escape":this.closeMenu()}},i.prototype.handlingMap=function(t){switch(t){case"ArrowUp":this.moveMode?this.map.getCenter().lat<e.CONST.LAT_MAX&&this.moveMap(1,0):this.mapZoom<e.CONST.ZOOM_MAX&&(this.zoomMap(1),this.moveShift/=2);break;case"ArrowDown":this.moveMode?this.map.getCenter().lat>-e.CONST.LAT_MAX&&this.moveMap(-1,0):this.mapZoom>e.CONST.ZOOM_MIN&&(this.zoomMap(-1),this.moveShift*=2);break;case"ArrowRight":this.moveMode&&this.moveMap(0,1);break;case"ArrowLeft":this.moveMode&&this.moveMap(0,-1);break;case"Enter":this.changeMode();break;case"Escape":this.openMenu()}},i.prototype.changeMode=function(){this.moveMode=!this.moveMode,this.moveMode?(this.handleIcon="move",this.choiseMenu=1):(this.handleIcon="zoom",this.choiseMenu=2)},i.prototype.sendModifications=function(e){var t=this.map.getSize(),n=this.map.project([this.mapLat,this.mapLng],this.mapZoom),i=this.map.unproject([n.x-t.x/2,n.y-t.y/2],this.mapZoom),a=this.map.unproject([n.x+t.x/2,n.y+t.y/2],this.mapZoom);this.onchange.emit({key:e,zoom:this.mapZoom,lat:this.mapLat,lng:this.mapLng,view:{top:i.lat,left:i.lng,bottom:a.lat,right:a.lng}})},i.prototype.sendSelectEvent=function(e){this.onselect.emit(e)},i.prototype.openMenu=function(){this.displayMenu="show-menu"},i.prototype.closeMenu=function(){this.displayMenu=""},i.prototype.selectMenu=function(e){"Escape"==e&&this.closeMenu()},i.prototype.setNavigationMode=function(){this.navigate=!0,this.handleIcon="navigation",this.navigateMarker(0,0),this.moveMode=!1,this.handleMenuIcon="move"},i.prototype.navigateMarker=function(e,t){if(this.marker.length){if(1==this.marker.length)return this.navigateId=0,void(this.elem.nativeElement.querySelector("#marker_"+this.navigateId).style.background="orange");this.navigateId>this.marker.length&&(this.navigateId=0),0==e&&0==t||(this.elem.nativeElement.querySelector("#marker_"+this.marker[this.navigateId].id).style.background="white"),t>0?this.findFirstRightElement():t<0?this.findFirstLeftElement():e>0?this.findFirstTopElement():e<0?this.findFirstBottomElement():this.navigateId=0;var n=this.marker[this.navigateId];this.mapLat=n.lat,this.mapLng=n.lng,this.moveMap(0,0),this.sendModifications("")}},i.prototype.calcAngle=function(e,t){return Math.atan(Math.abs(t)/Math.abs(e))*(180/Math.PI)},i.prototype.calcHyp=function(e,t){return Math.sqrt(Math.pow(e,2)+Math.pow(t,2))},i.prototype.findFirstLeftElement=function(){var e=this,t=this.marker[this.navigateId],n=null;this.marker.forEach((function(i){i!=t&&i.lng<t.lng&&(null==n||i.lng>n.lng||n.lng>t.lng)&&(e.calcAngle(i.lng-t.lng,i.lat-t.lat)<45&&(n=i))})),null==n||n.lng>=t.lng?this.navigateId=t.id:this.navigateId=n.id},i.prototype.findFirstRightElement=function(){var e=this,t=this.marker[this.navigateId],n=null;this.marker.forEach((function(i){i!=t&&i.lng>t.lng&&(null==n||i.lng<n.lng||n.lng<t.lng)&&(e.calcAngle(i.lng-t.lng,i.lat-t.lat)<45&&(n=i))})),null==n||n.lng<=t.lng?this.navigateId=t.id:this.navigateId=n.id},i.prototype.findFirstBottomElement=function(){var e=this.marker[this.navigateId],t=this.marker[0==this.navigateId?1:0];this.marker.forEach((function(n){n!=e&&n.lat<e.lat&&(n.lat>t.lat||t.lat>e.lat)&&(t=n)})),t.lat>=e.lat?this.navigateId=e.id:this.navigateId=t.id},i.prototype.findFirstTopElement=function(){var e=this.marker[this.navigateId],t=this.marker[0==this.navigateId?1:0];this.marker.forEach((function(n){n!=e&&n.lat>e.lat&&(n.lat<t.lat||t.lat<e.lat)&&(t=n)})),t.lat<=e.lat?this.navigateId=e.id:this.navigateId=t.id},i.prototype.setPosition=function(){var e=this.map.getCenter();this.mapLat=e.lat,this.mapLng=e.lng,this.mapZoom=this.map.getZoom(),this.setMoveShift()},i.prototype.moveMap=function(e,t){this.mapLat+=e*this.moveShift,this.mapLng+=t*this.moveShift,this.map.setView([this.mapLat,this.mapLng],this.mapZoom)},i.prototype.zoomMap=function(e){this.mapZoom+=e,this.map.setZoom(this.mapZoom)},i.prototype.setMoveShift=function(){this.moveShift=80;for(var e=1;e<this.mapZoom;e++)this.moveShift/=2},i.prototype.initInput=function(){this.searchInput=this.elem.nativeElement.querySelector(".leaflet-control-geocoder-form input"),this.searchBar=this.elem.nativeElement.querySelector(".leaflet-bar"),this.setFocusOut()},i.prototype.setFocus=function(){this.searchBar.style.display="block",this.searchInput.focus(),this.searchInputFocused=!0},i.prototype.setFocusOut=function(){this.searchInput.blur(),this.searchBar.style.display="none",this.searchInputFocused=!1,this.setPosition()},i.ɵfac=function(e){return new(e||i)(t.ɵɵdirectiveInject(t.ElementRef))},i.ɵcmp=t.ɵɵdefineComponent({type:i,selectors:[["map-library"]],hostBindings:function(e,n){1&e&&t.ɵɵlistener("keyup",(function(e){return n.keyEvent(e)}),!1,t.ɵɵresolveWindow)},inputs:{mapLat:"mapLat",mapLng:"mapLng",mapZoom:"mapZoom",search:"search",marker:"marker",focused:"focused"},outputs:{onchange:"onchange",onselect:"onselect"},features:[t.ɵɵNgOnChangesFeature],decls:10,vars:21,consts:[[1,"map-container"],["id","map"],[1,"menu-container"],[1,"menu-box"]],template:function(e,n){1&e&&(t.ɵɵelementStart(0,"div",0),t.ɵɵelement(1,"i"),t.ɵɵelement(2,"div",1),t.ɵɵelementEnd(),t.ɵɵelementStart(3,"div",2),t.ɵɵelementStart(4,"div",3),t.ɵɵelement(5,"i"),t.ɵɵelement(6,"i"),t.ɵɵelement(7,"i"),t.ɵɵelement(8,"i"),t.ɵɵelement(9,"i"),t.ɵɵelementEnd(),t.ɵɵelementEnd()),2&e&&(t.ɵɵadvance(1),t.ɵɵclassMapInterpolate1("icon ",n.handleIcon,""),t.ɵɵadvance(2),t.ɵɵclassMap(n.displayMenu),t.ɵɵadvance(2),t.ɵɵclassMapInterpolate1("icon search ",0==n.choiseMenu?"selected":"",""),t.ɵɵadvance(1),t.ɵɵclassMapInterpolate1("icon move ",1==n.choiseMenu?"selected":"",""),t.ɵɵadvance(1),t.ɵɵclassMapInterpolate1("icon zoom ",2==n.choiseMenu?"selected":"",""),t.ɵɵadvance(1),t.ɵɵclassMapInterpolate1("icon navigation ",3==n.choiseMenu?"selected":"",""),t.ɵɵadvance(1),t.ɵɵclassMapInterpolate1("icon logout ",4==n.choiseMenu?"selected":"",""))},styles:[".map-container[_ngcontent-%COMP%]{position:absolute;z-index:1;top:0;left:0;right:0;bottom:0}#map[_ngcontent-%COMP%]{width:100%;height:100%}.map-container[_ngcontent-%COMP%]   .icon[_ngcontent-%COMP%]{position:absolute;z-index:1000;top:10px;right:10px;width:50px;height:50px}.menu-container[_ngcontent-%COMP%]{position:absolute;z-index:1001;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.3);display:none}.menu-box[_ngcontent-%COMP%]{position:absolute;top:calc(50% - 100px);left:calc(50% - 375px);width:750px;height:150px;background-color:#fff;border:1px solid orange!important;text-align:center;margin-top:50px}.menu-box[_ngcontent-%COMP%]   .icon[_ngcontent-%COMP%]{display:inline-block;width:150px;height:150px;border:0;border-radius:3px;background-size:100px 100px;background-repeat:no-repeat;background-position:center}.menu-box[_ngcontent-%COMP%]   .selected[_ngcontent-%COMP%]{background-color:orange}.show-menu[_ngcontent-%COMP%]{display:block}"]}),i}(),s=function(){function e(){}return e.ɵmod=t.ɵɵdefineNgModule({type:e}),e.ɵinj=t.ɵɵdefineInjector({factory:function(t){return new(t||e)},imports:[[]]}),e}();("undefined"==typeof ngJitMode||ngJitMode)&&t.ɵɵsetNgModuleScope(s,{declarations:[o],exports:[o]}),e.MapLibraryComponent=o,e.MapLibraryModule=s,e.MapLibraryService=a,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=map-library.umd.min.js.map